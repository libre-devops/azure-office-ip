---
name: $(Build.DefinitionName)-$(date:yyyyMMdd)$(rev:.r)

trigger: none

# parameters are typed with defaults so they are correctly populated, you will get a choice in the GUI to edit these, but you should keep all changes as code.
parameters:

  - name: SHORTHAND_ENVIRONMENT_NAME
    default: dev
    displayName: "What is the shorthand name for this environment?"
    type: string
    values:
      - dev
      - poc
      - mvp
      - tst
      - uat
      - ppd
      - prd

  - name: SHORTHAND_PROJECT_NAME
    type: string
    default: "ldo"
    displayName: "Shorthand Project e.g. lbdo for libredevops"

  - name: CODE_VERSION
    type: string
    default: "3.9"
    displayName: "What is version of your language stack, e.g. for python - 3.9?"

  - name: CODE_ARCH
    type: string
    default: "x64"
    displayName: "What is your architecture? Defaults to x64"

  - name: CODE_PATH
    type: string
    default: "$(Build.SourcesDirectory)/azure-office-ip/og-code"
    displayName: "What version of terraform should be installed?"

  - name: ARCHIVE_PATH
    type: string
    default: "$(Build.ArtifactStagingDirectory)"
    displayName: "Desired archive file path"

  - name: ARCHIVE_TYPE
    type: string
    default: "zip"
    displayName: "Archive Type"
    values:
      - zip
      - tar
      - 7z
      - wim

  - name: ARCHIVE_FILE_NAME
    type: string
    default: "$(Build.BuildId)"
    displayName: "Desired archive file name"

  - name: ARTIFACT_NAME
    type: string
    default: "lbdo-fnc-drop"
    displayName: "The name of the artifact"

  - name: STORE_ARTIFACT_AS_TAR
    type: boolean
    default: false
    displayName: "Do you wish to tar the artifact before upload, defaults to false"

  - name: VARIABLE_GROUP_NAME
    type: string
    default: "svp-kv-ldo-euw-dev-mgt-01"
    displayName: "Enter the variable group which contains your authentication information"

  - name: AZDO_SERVICE_CONNECTION_NAME
    type: string
    default: "svp-ldo-euw-dev-mgt-01"
    displayName: "The name of the azdo service connection which has IAM to your function app"

  - name: FUNCTION_APP_NAME
    type: string
    default: "fnc-ldo-euw-dev-01"
    displayName: "The name of the function app you wish to deploy too"

  - name: FUNCTION_APP_TYPE
    type: string
    default: "functionAppLinux"
    displayName: "The type of function app"
    values:
      - "functionApp"
      - "functionAppLinux"

  - name: FUNCTION_APP_RUNTIME_STACK
    type: string
    default: "PYTHON|3.8"
    displayName: "The type of Azure function app you are deploying too"

  - name: FUNCTION_APP_STARTUP_COMMAND
    type: string
    default: "__init__.py"
    displayName: "The function startup cmd"

# Sets what repos need cloned, for example, a library repo for modules and a poly-repo for target code
resources:
  repositories:

  - repository: azdo-azure-function-package-and-deploy-pipeline-template
    type: github
    endpoint: github_service_connection
    name: libre-devops/azdo-azure-function-package-and-deploy-pipeline-template
    ref: main

# You may wish to use a separate or self-hosted agent per job, by default, all jobs will inherit stage agent
pool:
  name: Azure Pipelines
  vmImage: ubuntu-latest

# Sets stage so that multiple stages can be used if needed, as it stands, only 1 stage is expected and is thus passed as a parameter
stages:
  - stage: "${{ parameters.SHORTHAND_ENVIRONMENT_NAME }}"
    displayName: "${{ parameters.SHORTHAND_ENVIRONMENT_NAME }} Stage"
    jobs:
      - job: Terraform_Build
        workspace:
          clean: all
        displayName: Terraform Build
        steps:

          # Declare the repos needed from the resources list
          - checkout: self

          # Remotely fetch pipeline template, in this case, I am using one in my development repo.
          - template: /.azurepipelines/.templates/.python/function-app-package-and-deploy.yml@azdo-azure-function-package-and-deploy-pipeline-template
            parameters:
              CODE_VERSION: ${{ parameters.CODE_VERSION }}
              CODE_ARCH: ${{ parameters.CODE_ARCH }}
              CODE_PATH: ${{ parameters.CODE_PATH }}
              FILE_TO_ARCHIVE: ${{ parameters.CODE_PATH }}
              ARCHIVE_TYPE: ${{ parameters.ARCHIVE_TYPE }}
              ARCHIVE_PATH: ${{ parameters.ARCHIVE_PATH }}
              ARCHIVE_FILE_NAME: ${{ parameters.ARCHIVE_FILE_NAME }}.${{ parameters.ARCHIVE_TYPE }}
              ARTIFACT_NAME: ${{ parameters.ARTIFACT_NAME }}
              STORE_ARTIFACT_AS_TAR: ${{ parameters.STORE_ARTIFACT_AS_TAR }}
              AZDO_SERVICE_CONNECTION_NAME: ${{ parameters.AZDO_SERVICE_CONNECTION_NAME }}
              FUNCTION_APP_TYPE: ${{ parameters.FUNCTION_APP_TYPE }}
              FUNCTION_APP_NAME: ${{ parameters.FUNCTION_APP_NAME }}
              FUNCTION_APP_PACKAGE_PATH: "${{ parameters.ARCHIVE_PATH }}/${{ parameters.ARCHIVE_FILE_NAME }}"
              FUNCTION_APP_RUNTIME_STACK: ${{ parameters.FUNCTION_APP_RUNTIME_STACK }}
              FUNCTION_APP_STARTUP_COMMAND: ${{ parameters.FUNCTION_APP_STARTUP_COMMAND }}
